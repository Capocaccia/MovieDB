"use strict";

var info = "http://www.omdbapi.com/?t=";
var title = $('.movie').val();
var url = info + title;
var FIREBASE_URL = "https://flickpicker.firebaseio.com/flicks.json";
var FIREBASE_AUTH = 'https://flickpicker.firebaseio.com';
var fb = new Firebase(FIREBASE_AUTH);
var scoreArr = [];

//taste test button works.
$('.tasteTest').on('click', function () {
  var scoreTotalArr = scoreArr.split(" ").map(Number);
  var $ttResult = $(".rating");
  var total = scoreTotalArr.reduce(function (prev, curr) {
    return prev + curr;
  });
  if (total >= 45) {
    addTasteTestResult(total);
    $ttResult.append('<img src="http://upload.wikimedia.org/wikipedia/en/thumb/2/2d/Certified_Fresh.svg/150px-Certified_Fresh.svg.png"</img>');
    //alert("Hey, you know good film when you see it!  You should put down your friends opinions about movies now because your opinions are better and have been reaffirmed by me.  Got it?")
  } else if (total >= 40) {
      alert("Alright, you like good movies but have some guilty pleasures.  Its ok.  I like Mean Girls too.");
    } else if (total >= 35) {
      alert("Sometimes I wonder if we mean the same thing by 'good'...");
    } else if (total >= 30) {
      alert("Step your game up.  Might I recommend starting with 'Goodfellas or The Departed?'");
    } else if (total < 30) {
      alert("You probably talk and text in theaters and definitely dont deserve a Netflix account.");
    };
});

//appending taste test result to page
function addTasteTestResult(total) {
  var $removeBtn = $('.remove');
  var $ttResult = $(".rating");
  $removeBtn.removeClass('hidden');
  $ttResult.append("Taste Test Score: ", total);
  $ttResult.removeClass('hidden');
}

// //trying to get the taste test result to hide on button click
$('.remove').on('click', function () {
  var $ttResult = $(".rating");
  var $removeBtn = $('.remove');
  $removeBtn.addClass('hidden');
  $ttResult.addClass("hidden");
  $ttResult.empty('.rating');
});

//on page load it checks if you are logged in.  If you arent, it sends you to login page.
$(document).ready(function () {
  if (!/login\.html/.test(window.location.pathname) && !fb.getAuth()) {
    window.location = 'login.html';
  }
});

//search button working and done
$('.search').on('click', function () {
  var input = document.querySelector("#movieName");
  var title = input.value;
  var url = info + title;
  var uid = fb.getAuth().uid;
  var token = fb.getAuth().token;
  var postUrl = FIREBASE_AUTH + "/users/" + uid + "/flicks.json?auth=" + token;
  $.get(url, function (data) {
    console.log(data.Poster);
    if (data.Response === "True") {
      $.post(postUrl, JSON.stringify(data), function (res) {
        console.log("Post Request Passed");
      });
      addMovieDetail(data);
    } else {
      alert("Sorry! Film not found! Check title and try again!");
    }
  }, 'jsonp');
});

//loads data per user and keeps its persisting
$(document).ready(function () {
  if (!/login\.html/.test(window.location.pathname) && fb.getAuth() !== null) {
    var uid = fb.getAuth().uid;
    var token = fb.getAuth().token;
    var MovieListUrl = FIREBASE_AUTH + "/users/" + uid + "/flicks.json?auth=" + token;
    $.get(MovieListUrl, function (movies) {
      Object.keys(movies).forEach(function (id) {
        addMovieDetail(movies[id], id);
      });
    });
  }
});

function addMovieDetail(data, id) {
  var $table = $(".table");
  $table.append("<tr></tr>");
  var $target = $("tr:last");
  scoreArr = scoreArr + Math.round(data.imdbRating) + " ";
  $target.attr("data-id", id);
  $target.append("<td>" + data.Title + "</td>");
  $target.append("<td>" + data.imdbRating + "</td>");
  $target.append("<td>" + data.Released + "</td>");
  $target.append("<td><img width='200' height='250' src=" + data.Poster + "></img></td>");
  $target.append("<button class='delete'>Delete</button>");
};

///Deletes individual users data from firebase
var $button = $('.table');
$button.on("click", ".delete", function () {
  var uid = fb.getAuth().uid;
  var token = fb.getAuth().token;
  var $movieRow = $(this).closest('tr');
  var id = $movieRow.attr('data-id');
  var deleteUrl = FIREBASE_AUTH + '/' + 'users' + '/' + uid + '/' + 'flicks' + '/' + id + '.json';
  $.ajax({
    url: deleteUrl,
    type: 'DELETE',
    success: function success() {
      $movieRow.remove();
    }
  });
});

//everything below this point is for login.html

//login button
$('.loginPageForm form').on('submit', function (evt) {
  var email = $('.loginPageForm input[type="email"]').val();
  var password = $('.loginPageForm input[type="password"]').val();
  var onTempPassword = $('.onTempPassword');
  evt.preventDefault();
  fb.authWithPassword({
    email: email,
    password: password
  }, function (err, authData) {
    if (err) {
      alert(err.toString());
    } else if (authData && authData.password.isTemporaryPassword) {
      onTempPassword.removeClass('hidden');
      alert("Please change your password now.");
    } else {
      window.location = 'index.html';
    }
  });
});

// runs when called by registration button if  successful
function doLogin(email, password, cb) {
  fb.authWithPassword({
    email: email,
    password: password
  }, function (err, authData) {
    if (err) {
      alert(err.toString());
    } else {
      saveAuthData(authData);
      typeof cb === 'function' && cb(authData);
      window.location = 'index.html';
      alert("Registration Successful!");
    }
  });
}

//saves the authentication data to firebase
function saveAuthData(authData) {
  $.ajax({
    method: 'PUT',
    url: FIREBASE_AUTH + "/users/" + authData.uid + "/profile.json",
    data: JSON.stringify(authData)
  });
}

//register button
$('.loginPageForm .doRegister').click(function () {
  var email = $('.loginPageForm input[type="email"]').val();
  var password = $('.loginPageForm input[type="password"]').val();

  fb.createUser({
    email: email,
    password: password
  }, function (err, userData) {
    if (err) {
      alert(err.toString());
    } else {
      doLogin(email, password);
    }
  });
  event.preventDefault();
});

//forgot password button
$('.loginPageForm .doResetPassword').click(function () {
  var email = $('.loginPageForm input[type="email"]').val();

  fb.resetPassword({
    email: email
  }, function (err) {
    if (err) {
      alert(err.toString());
    } else {
      alert('Check your email!');
    }
  });
});

//reset password form
$('.onTempPassword form').submit(function () {
  var email = fb.getAuth().password.email;
  var oldPw = $('.onTempPassword input:nth-child(1)').val();
  var newPw = $('.onTempPassword input:nth-child(2)').val();

  fb.changePassword({
    email: email,
    oldPassword: oldPw,
    newPassword: newPw
  }, function (err) {
    if (err) {
      alert(err.toString());
    } else {
      fb.unauth();
    }
  });

  event.preventDefault();
});

//reset password button
$('.onTempPassword form').submit(function () {
  var email = fb.getAuth().password.email;
  var oldPw = $('.onTempPassword input:nth-child(1)').val();
  var newPw = $('.onTempPassword input:nth-child(2)').val();

  fb.changePassword({
    email: email,
    oldPassword: oldPw,
    newPassword: newPw
  }, function (err) {
    if (err) {
      alert(err.toString());
    } else {
      fb.unauth();
      window.location = 'index.html';
    }
  });

  event.preventDefault();
});

//logout button
$('.logout').on('click', function () {
  fb.unauth();
  window.location = 'index.html';
});
//# sourceMappingURL=data:application/json;base64,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QUMsQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDOztBQUUxRCxJQUFFLENBQUMsY0FBYyxDQUFDO0FBQ2hCLFNBQUssRUFBRSxLQUFLO0FBQ1osZUFBVyxFQUFFLEtBQUs7QUFDbEIsZUFBVyxFQUFFLEtBQUs7R0FDbkIsRUFBRSxVQUFTLEdBQUcsRUFBRTtBQUNmLFFBQUksR0FBRyxFQUFFO0FBQ1AsV0FBSyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO0tBQ3ZCLE1BQU07QUFDTCxRQUFFLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDWixZQUFNLENBQUMsUUFBUSxHQUFHLFlBQVksQ0FBQTtLQUMvQjtHQUNGLENBQUMsQ0FBQzs7QUFFSCxPQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7Q0FDeEIsQ0FBQyxDQUFBOzs7QUFHRixDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxZQUFXO0FBQ2xDLElBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUNaLFFBQU0sQ0FBQyxRQUFRLEdBQUcsWUFBWSxDQUFBO0NBQy9CLENBQUMsQ0FBQyIsImZpbGUiOiJtYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGluZm8gPSBcImh0dHA6Ly93d3cub21kYmFwaS5jb20vP3Q9XCI7XG52YXIgdGl0bGUgPSAkKCcubW92aWUnKS52YWwoKTtcbnZhciB1cmwgPSBpbmZvICsgdGl0bGU7XG52YXIgRklSRUJBU0VfVVJMID0gXCJodHRwczovL2ZsaWNrcGlja2VyLmZpcmViYXNlaW8uY29tL2ZsaWNrcy5qc29uXCJcbnZhciBGSVJFQkFTRV9BVVRIID0gJ2h0dHBzOi8vZmxpY2twaWNrZXIuZmlyZWJhc2Vpby5jb20nO1xudmFyIGZiID0gbmV3IEZpcmViYXNlKEZJUkVCQVNFX0FVVEgpO1xudmFyIHNjb3JlQXJyID0gW107XG5cblxuLy90YXN0ZSB0ZXN0IGJ1dHRvbiB3b3Jrcy5cbiQoJy50YXN0ZVRlc3QnKS5vbignY2xpY2snLCBmdW5jdGlvbigpe1xuICB2YXIgc2NvcmVUb3RhbEFyciA9IHNjb3JlQXJyLnNwbGl0KFwiIFwiKS5tYXAoTnVtYmVyKTtcbiAgdmFyICR0dFJlc3VsdD0kKFwiLnJhdGluZ1wiKTtcbiAgdmFyIHRvdGFsID0gc2NvcmVUb3RhbEFyci5yZWR1Y2UoZnVuY3Rpb24ocHJldiwgY3Vycikge1xuICByZXR1cm4gcHJldiArIGN1cnI7XG59KTtcbmlmICh0b3RhbCA+PSA0NSkge1xuICBhZGRUYXN0ZVRlc3RSZXN1bHQodG90YWwpO1xuICAkdHRSZXN1bHQuYXBwZW5kKCc8aW1nIHNyYz1cImh0dHA6Ly91cGxvYWQud2lraW1lZGlhLm9yZy93aWtpcGVkaWEvZW4vdGh1bWIvMi8yZC9DZXJ0aWZpZWRfRnJlc2guc3ZnLzE1MHB4LUNlcnRpZmllZF9GcmVzaC5zdmcucG5nXCI8L2ltZz4nKVxuICAgIC8vYWxlcnQoXCJIZXksIHlvdSBrbm93IGdvb2QgZmlsbSB3aGVuIHlvdSBzZWUgaXQhICBZb3Ugc2hvdWxkIHB1dCBkb3duIHlvdXIgZnJpZW5kcyBvcGluaW9ucyBhYm91dCBtb3ZpZXMgbm93IGJlY2F1c2UgeW91ciBvcGluaW9ucyBhcmUgYmV0dGVyIGFuZCBoYXZlIGJlZW4gcmVhZmZpcm1lZCBieSBtZS4gIEdvdCBpdD9cIilcbiAgfSBlbHNlIGlmICh0b3RhbCA+PSA0MCkge1xuICAgIGFsZXJ0KFwiQWxyaWdodCwgeW91IGxpa2UgZ29vZCBtb3ZpZXMgYnV0IGhhdmUgc29tZSBndWlsdHkgcGxlYXN1cmVzLiAgSXRzIG9rLiAgSSBsaWtlIE1lYW4gR2lybHMgdG9vLlwiKVxuICAgIH1cbiAgICBlbHNlIGlmICh0b3RhbCA+PSAzNSkge1xuICAgICAgYWxlcnQoXCJTb21ldGltZXMgSSB3b25kZXIgaWYgd2UgbWVhbiB0aGUgc2FtZSB0aGluZyBieSAnZ29vZCcuLi5cIilcbiAgICAgIH1cbiAgICAgIGVsc2UgaWYodG90YWwgPj0gMzApIHtcbiAgICAgICAgYWxlcnQoXCJTdGVwIHlvdXIgZ2FtZSB1cC4gIE1pZ2h0IEkgcmVjb21tZW5kIHN0YXJ0aW5nIHdpdGggJ0dvb2RmZWxsYXMgb3IgVGhlIERlcGFydGVkPydcIilcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmKHRvdGFsIDwgMzApe1xuICAgICAgICAgIGFsZXJ0KFwiWW91IHByb2JhYmx5IHRhbGsgYW5kIHRleHQgaW4gdGhlYXRlcnMgYW5kIGRlZmluaXRlbHkgZG9udCBkZXNlcnZlIGEgTmV0ZmxpeCBhY2NvdW50LlwiKVxuICAgICAgICAgIH07XG59KTtcblxuLy9hcHBlbmRpbmcgdGFzdGUgdGVzdCByZXN1bHQgdG8gcGFnZVxuZnVuY3Rpb24gYWRkVGFzdGVUZXN0UmVzdWx0KHRvdGFsKXtcbiAgICB2YXIgJHJlbW92ZUJ0biA9ICQoJy5yZW1vdmUnKVxuICAgIHZhciAkdHRSZXN1bHQ9JChcIi5yYXRpbmdcIik7XG4gICAgJHJlbW92ZUJ0bi5yZW1vdmVDbGFzcygnaGlkZGVuJyk7XG4gICAgJHR0UmVzdWx0LmFwcGVuZChcIlRhc3RlIFRlc3QgU2NvcmU6IFwiLCB0b3RhbCk7XG4gICAgJHR0UmVzdWx0LnJlbW92ZUNsYXNzKCdoaWRkZW4nKTtcblxuICB9XG5cbi8vIC8vdHJ5aW5nIHRvIGdldCB0aGUgdGFzdGUgdGVzdCByZXN1bHQgdG8gaGlkZSBvbiBidXR0b24gY2xpY2tcbiQoJy5yZW1vdmUnKS5vbignY2xpY2snLCBmdW5jdGlvbigpe1xuICAgIHZhciAkdHRSZXN1bHQgPSAkKFwiLnJhdGluZ1wiKTtcbiAgICB2YXIgJHJlbW92ZUJ0biA9ICQoJy5yZW1vdmUnKVxuICAgICRyZW1vdmVCdG4uYWRkQ2xhc3MoJ2hpZGRlbicpO1xuICAgICR0dFJlc3VsdC5hZGRDbGFzcyhcImhpZGRlblwiKTtcbiAgICAkdHRSZXN1bHQuZW1wdHkoJy5yYXRpbmcnKTtcbiAgfSlcblxuLy9vbiBwYWdlIGxvYWQgaXQgY2hlY2tzIGlmIHlvdSBhcmUgbG9nZ2VkIGluLiAgSWYgeW91IGFyZW50LCBpdCBzZW5kcyB5b3UgdG8gbG9naW4gcGFnZS5cbiQoIGRvY3VtZW50ICkucmVhZHkoZnVuY3Rpb24oKSB7XG5pZiAoISgvbG9naW5cXC5odG1sLy50ZXN0KHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSkpICYmICFmYi5nZXRBdXRoKCkpIHtcbiB3aW5kb3cubG9jYXRpb24gPSdsb2dpbi5odG1sJztcbiAgICB9XG4gIH0pO1xuXG4vL3NlYXJjaCBidXR0b24gd29ya2luZyBhbmQgZG9uZVxuJCgnLnNlYXJjaCcpLm9uKCdjbGljaycsIGZ1bmN0aW9uKCkge1xuICB2YXIgaW5wdXQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiI21vdmllTmFtZVwiKTtcbiAgdmFyIHRpdGxlID0gaW5wdXQudmFsdWU7XG4gIHZhciB1cmwgPSBpbmZvICsgdGl0bGU7XG4gIHZhciB1aWQgPSBmYi5nZXRBdXRoKCkudWlkO1xuICB2YXIgdG9rZW4gPSBmYi5nZXRBdXRoKCkudG9rZW47XG4gIHZhciBwb3N0VXJsID0gYCR7RklSRUJBU0VfQVVUSH0vdXNlcnMvJHt1aWR9L2ZsaWNrcy5qc29uP2F1dGg9JHt0b2tlbn1gO1xuICAkLmdldCh1cmwsIGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgY29uc29sZS5sb2coZGF0YS5Qb3N0ZXIpO1xuICAgIGlmKGRhdGEuUmVzcG9uc2UgPT09IFwiVHJ1ZVwiKXtcbiAgICAkLnBvc3QocG9zdFVybCwgSlNPTi5zdHJpbmdpZnkoZGF0YSksIGZ1bmN0aW9uIChyZXMpIHtcbiAgICBjb25zb2xlLmxvZyhcIlBvc3QgUmVxdWVzdCBQYXNzZWRcIilcbiAgfSk7XG4gICAgYWRkTW92aWVEZXRhaWwoZGF0YSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGFsZXJ0KFwiU29ycnkhIEZpbG0gbm90IGZvdW5kISBDaGVjayB0aXRsZSBhbmQgdHJ5IGFnYWluIVwiKVxuICAgIH1cbiAgfSwgJ2pzb25wJyk7XG59KTtcblxuLy9sb2FkcyBkYXRhIHBlciB1c2VyIGFuZCBrZWVwcyBpdHMgcGVyc2lzdGluZ1xuJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKXtcbiAgaWYgKCEoL2xvZ2luXFwuaHRtbC8udGVzdCh3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUpKSAmJiBmYi5nZXRBdXRoKCkgIT09IG51bGwpe1xuICAgIHZhciB1aWQgPSBmYi5nZXRBdXRoKCkudWlkO1xuICAgIHZhciB0b2tlbiA9IGZiLmdldEF1dGgoKS50b2tlbjtcbiAgICB2YXIgTW92aWVMaXN0VXJsID0gYCR7RklSRUJBU0VfQVVUSH0vdXNlcnMvJHt1aWR9L2ZsaWNrcy5qc29uP2F1dGg9JHt0b2tlbn1gO1xuICAgICQuZ2V0KE1vdmllTGlzdFVybCwgZnVuY3Rpb24gKG1vdmllcykge1xuICAgICAgT2JqZWN0LmtleXMobW92aWVzKS5mb3JFYWNoKGZ1bmN0aW9uIChpZCkge1xuICAgICAgYWRkTW92aWVEZXRhaWwobW92aWVzW2lkXSwgaWQpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbn0pO1xuXG5cbmZ1bmN0aW9uIGFkZE1vdmllRGV0YWlsKGRhdGEsIGlkKXtcbiAgdmFyICR0YWJsZT0kKFwiLnRhYmxlXCIpO1xuICAgICR0YWJsZS5hcHBlbmQoXCI8dHI+PC90cj5cIik7XG4gICAgdmFyICR0YXJnZXQ9JChcInRyOmxhc3RcIik7XG4gICAgc2NvcmVBcnIgPSBzY29yZUFyciArIE1hdGgucm91bmQoZGF0YS5pbWRiUmF0aW5nKSArIFwiIFwiO1xuICAgICAgJHRhcmdldC5hdHRyKFwiZGF0YS1pZFwiLCBpZCk7XG4gICAgICAkdGFyZ2V0LmFwcGVuZChcIjx0ZD5cIiArIGRhdGEuVGl0bGUgKyBcIjwvdGQ+XCIpO1xuICAgICAgJHRhcmdldC5hcHBlbmQoXCI8dGQ+XCIgKyBkYXRhLmltZGJSYXRpbmcgKyBcIjwvdGQ+XCIpO1xuICAgICAgJHRhcmdldC5hcHBlbmQoXCI8dGQ+XCIgKyBkYXRhLlJlbGVhc2VkICsgXCI8L3RkPlwiKTtcbiAgICAgICR0YXJnZXQuYXBwZW5kKFwiPHRkPjxpbWcgd2lkdGg9JzIwMCcgaGVpZ2h0PScyNTAnIHNyYz1cIiArIGRhdGEuUG9zdGVyICsgXCI+PC9pbWc+PC90ZD5cIik7XG4gICAgICAkdGFyZ2V0LmFwcGVuZChcIjxidXR0b24gY2xhc3M9J2RlbGV0ZSc+RGVsZXRlPC9idXR0b24+XCIpO1xufTtcblxuLy8vRGVsZXRlcyBpbmRpdmlkdWFsIHVzZXJzIGRhdGEgZnJvbSBmaXJlYmFzZVxudmFyICRidXR0b24gPSAkKCcudGFibGUnKTtcbiRidXR0b24ub24oXCJjbGlja1wiLCBcIi5kZWxldGVcIiwgZnVuY3Rpb24oKSB7XG4gIHZhciB1aWQgPSBmYi5nZXRBdXRoKCkudWlkO1xuICB2YXIgdG9rZW4gPSBmYi5nZXRBdXRoKCkudG9rZW5cbiAgdmFyICRtb3ZpZVJvdyA9ICQodGhpcykuY2xvc2VzdCgndHInKTtcbiAgdmFyIGlkID0gJG1vdmllUm93LmF0dHIoJ2RhdGEtaWQnKTtcbiAgdmFyIGRlbGV0ZVVybCA9IEZJUkVCQVNFX0FVVEggKyAnLycgKyAndXNlcnMnICsgJy8nICsgdWlkICsgJy8nICsgJ2ZsaWNrcycgKyAnLycgKyBpZCArICcuanNvbic7XG4gICAgJC5hamF4KHtcbiAgICB1cmw6IGRlbGV0ZVVybCxcbiAgICB0eXBlOiAnREVMRVRFJyxcbiAgICBzdWNjZXNzOiBmdW5jdGlvbigpIHtcbiAgICAgICRtb3ZpZVJvdy5yZW1vdmUoKTtcbiAgICB9XG4gIH0pXG59KTtcblxuLy9ldmVyeXRoaW5nIGJlbG93IHRoaXMgcG9pbnQgaXMgZm9yIGxvZ2luLmh0bWxcblxuLy9sb2dpbiBidXR0b25cbiQoJy5sb2dpblBhZ2VGb3JtIGZvcm0nKS5vbignc3VibWl0JywgZnVuY3Rpb24gKGV2dCkge1xuICB2YXIgZW1haWwgPSAkKCcubG9naW5QYWdlRm9ybSBpbnB1dFt0eXBlPVwiZW1haWxcIl0nKS52YWwoKTtcbiAgdmFyIHBhc3N3b3JkID0gJCgnLmxvZ2luUGFnZUZvcm0gaW5wdXRbdHlwZT1cInBhc3N3b3JkXCJdJykudmFsKCk7XG4gIHZhciBvblRlbXBQYXNzd29yZCA9ICQoJy5vblRlbXBQYXNzd29yZCcpO1xuICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgZmIuYXV0aFdpdGhQYXNzd29yZCh7XG4gICAgZW1haWw6IGVtYWlsLFxuICAgIHBhc3N3b3JkOiBwYXNzd29yZFxuICB9LCBmdW5jdGlvbiAoZXJyLCBhdXRoRGF0YSkge1xuICAgIGlmIChlcnIpIHtcbiAgICAgIGFsZXJ0KGVyci50b1N0cmluZygpKTtcbiAgICB9IGVsc2UgaWYoYXV0aERhdGEgJiYgYXV0aERhdGEucGFzc3dvcmQuaXNUZW1wb3JhcnlQYXNzd29yZCkge1xuICAgICAgb25UZW1wUGFzc3dvcmQucmVtb3ZlQ2xhc3MoJ2hpZGRlbicpO1xuICAgICAgYWxlcnQoXCJQbGVhc2UgY2hhbmdlIHlvdXIgcGFzc3dvcmQgbm93LlwiKVxuICAgIH0gZWxzZSB7XG4gICAgICB3aW5kb3cubG9jYXRpb24gPSAnaW5kZXguaHRtbCdcbiAgICB9XG4gIH0pO1xufSk7XG5cbi8vIHJ1bnMgd2hlbiBjYWxsZWQgYnkgcmVnaXN0cmF0aW9uIGJ1dHRvbiBpZiAgc3VjY2Vzc2Z1bFxuZnVuY3Rpb24gZG9Mb2dpbiAoZW1haWwsIHBhc3N3b3JkLCBjYikge1xuICBmYi5hdXRoV2l0aFBhc3N3b3JkKHtcbiAgICBlbWFpbDogZW1haWwsXG4gICAgcGFzc3dvcmQ6IHBhc3N3b3JkXG4gIH0sIGZ1bmN0aW9uIChlcnIsIGF1dGhEYXRhKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgYWxlcnQoZXJyLnRvU3RyaW5nKCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzYXZlQXV0aERhdGEoYXV0aERhdGEpO1xuICAgICAgdHlwZW9mIGNiID09PSAnZnVuY3Rpb24nICYmIGNiKGF1dGhEYXRhKTtcbiAgICAgIHdpbmRvdy5sb2NhdGlvbiA9ICdpbmRleC5odG1sJ1xuICAgICAgYWxlcnQoXCJSZWdpc3RyYXRpb24gU3VjY2Vzc2Z1bCFcIilcbiAgICB9XG4gIH0pO1xufVxuXG4vL3NhdmVzIHRoZSBhdXRoZW50aWNhdGlvbiBkYXRhIHRvIGZpcmViYXNlXG5mdW5jdGlvbiBzYXZlQXV0aERhdGEgKGF1dGhEYXRhKSB7XG4gICQuYWpheCh7XG4gICAgbWV0aG9kOiAnUFVUJyxcbiAgICB1cmw6IGAke0ZJUkVCQVNFX0FVVEh9L3VzZXJzLyR7YXV0aERhdGEudWlkfS9wcm9maWxlLmpzb25gLFxuICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KGF1dGhEYXRhKVxuICB9KTtcbn1cblxuXG4vL3JlZ2lzdGVyIGJ1dHRvblxuJCgnLmxvZ2luUGFnZUZvcm0gLmRvUmVnaXN0ZXInKS5jbGljayhmdW5jdGlvbiAoKSB7XG4gIHZhciBlbWFpbCA9ICQoJy5sb2dpblBhZ2VGb3JtIGlucHV0W3R5cGU9XCJlbWFpbFwiXScpLnZhbCgpO1xuICB2YXIgcGFzc3dvcmQgPSAkKCcubG9naW5QYWdlRm9ybSBpbnB1dFt0eXBlPVwicGFzc3dvcmRcIl0nKS52YWwoKTtcblxuICBmYi5jcmVhdGVVc2VyKHtcbiAgICBlbWFpbDogZW1haWwsXG4gICAgcGFzc3dvcmQ6IHBhc3N3b3JkXG4gIH0sIGZ1bmN0aW9uIChlcnIsIHVzZXJEYXRhKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgYWxlcnQoZXJyLnRvU3RyaW5nKCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBkb0xvZ2luKGVtYWlsLCBwYXNzd29yZCk7XG4gICAgfVxuICB9KTtcbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbn0pO1xuXG4vL2ZvcmdvdCBwYXNzd29yZCBidXR0b25cbiQoJy5sb2dpblBhZ2VGb3JtIC5kb1Jlc2V0UGFzc3dvcmQnKS5jbGljayhmdW5jdGlvbiAoKSB7XG4gIHZhciBlbWFpbCA9ICQoJy5sb2dpblBhZ2VGb3JtIGlucHV0W3R5cGU9XCJlbWFpbFwiXScpLnZhbCgpO1xuXG4gIGZiLnJlc2V0UGFzc3dvcmQoe1xuICAgIGVtYWlsOiBlbWFpbFxuICB9LCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgYWxlcnQoZXJyLnRvU3RyaW5nKCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhbGVydCgnQ2hlY2sgeW91ciBlbWFpbCEnKTtcbiAgICB9XG4gIH0pO1xufSk7XG5cbi8vcmVzZXQgcGFzc3dvcmQgZm9ybVxuJCgnLm9uVGVtcFBhc3N3b3JkIGZvcm0nKS5zdWJtaXQoZnVuY3Rpb24gKCkge1xuICB2YXIgZW1haWwgPSBmYi5nZXRBdXRoKCkucGFzc3dvcmQuZW1haWw7XG4gIHZhciBvbGRQdyA9ICQoJy5vblRlbXBQYXNzd29yZCBpbnB1dDpudGgtY2hpbGQoMSknKS52YWwoKTtcbiAgdmFyIG5ld1B3ID0gJCgnLm9uVGVtcFBhc3N3b3JkIGlucHV0Om50aC1jaGlsZCgyKScpLnZhbCgpO1xuXG4gIGZiLmNoYW5nZVBhc3N3b3JkKHtcbiAgICBlbWFpbDogZW1haWwsXG4gICAgb2xkUGFzc3dvcmQ6IG9sZFB3LFxuICAgIG5ld1Bhc3N3b3JkOiBuZXdQd1xuICB9LCBmdW5jdGlvbihlcnIpIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBhbGVydChlcnIudG9TdHJpbmcoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZiLnVuYXV0aCgpO1xuICAgIH1cbiAgfSk7XG5cbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbn0pXG5cbi8vcmVzZXQgcGFzc3dvcmQgYnV0dG9uXG4kKCcub25UZW1wUGFzc3dvcmQgZm9ybScpLnN1Ym1pdChmdW5jdGlvbiAoKSB7XG4gIHZhciBlbWFpbCA9IGZiLmdldEF1dGgoKS5wYXNzd29yZC5lbWFpbDtcbiAgdmFyIG9sZFB3ID0gJCgnLm9uVGVtcFBhc3N3b3JkIGlucHV0Om50aC1jaGlsZCgxKScpLnZhbCgpO1xuICB2YXIgbmV3UHcgPSAkKCcub25UZW1wUGFzc3dvcmQgaW5wdXQ6bnRoLWNoaWxkKDIpJykudmFsKCk7XG5cbiAgZmIuY2hhbmdlUGFzc3dvcmQoe1xuICAgIGVtYWlsOiBlbWFpbCxcbiAgICBvbGRQYXNzd29yZDogb2xkUHcsXG4gICAgbmV3UGFzc3dvcmQ6IG5ld1B3XG4gIH0sIGZ1bmN0aW9uKGVycikge1xuICAgIGlmIChlcnIpIHtcbiAgICAgIGFsZXJ0KGVyci50b1N0cmluZygpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZmIudW5hdXRoKCk7XG4gICAgICB3aW5kb3cubG9jYXRpb24gPSAnaW5kZXguaHRtbCdcbiAgICB9XG4gIH0pO1xuXG4gIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG59KVxuXG4vL2xvZ291dCBidXR0b25cbiQoJy5sb2dvdXQnKS5vbignY2xpY2snLCBmdW5jdGlvbigpIHtcbiAgZmIudW5hdXRoKCk7XG4gIHdpbmRvdy5sb2NhdGlvbiA9ICdpbmRleC5odG1sJ1xufSk7XG4iXX0=