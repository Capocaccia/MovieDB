"use strict";

var info = "http://www.omdbapi.com/?t=";
var title = $('.movie').val();
var url = info + title;
var FIREBASE_URL = "https://flickpicker.firebaseio.com/flicks.json";
var FIREBASE_AUTH = 'https://flickpicker.firebaseio.com';
var fb = new Firebase(FIREBASE_AUTH);
var scoreArr = [];

//taste test button works.
$('.tasteTest').on('click', function () {
  var scoreTotalArr = scoreArr.split(" ").map(Number);
  var $ttResult = $(".rating");
  var total = scoreTotalArr.reduce(function (prev, curr) {
    return prev + curr;
  });
  if (total >= 45) {
    addTasteTestResult(total);
    $ttResult.append('<img src="http://upload.wikimedia.org/wikipedia/en/thumb/2/2d/Certified_Fresh.svg/150px-Certified_Fresh.svg.png"</img>');
    //alert("Hey, you know good film when you see it!  You should put down your friends opinions about movies now because your opinions are better and have been reaffirmed by me.  Got it?")
  } else if (total >= 40) {
      alert("Alright, you like good movies but have some guilty pleasures.  Its ok.  I like Mean Girls too.");
    } else if (total >= 35) {
      alert("Sometimes I wonder if we mean the same thing by 'good'...");
    } else if (total >= 30) {
      alert("Step your game up.  Might I recommend starting with 'Goodfellas or The Departed?'");
    } else if (total < 30) {
      alert("You probably talk and text in theaters and definitely dont deserve a Netflix account.");
    };
});

//appending taste test result to page
function addTasteTestResult(total) {
  var $removeBtn = $('.remove');
  var $ttResult = $(".rating");
  $removeBtn.removeClass('hidden');
  $ttResult.append("Taste Test Score: ", total);
  $ttResult.removeClass('hidden');
}

// //trying to get the taste test result to hide on button click
$('.remove').on('click', function () {
  var $ttResult = $(".rating");
  var $removeBtn = $('.remove');
  $removeBtn.addClass('hidden');
  $ttResult.addClass("hidden");
  $ttResult.empty('.rating');
});

//on page load it checks if you are logged in.  If you arent, it sends you to login page.
$(document).ready(function () {
  if (/login\.html/.test(window.location.pathname) && !fb.getAuth()) {
    window.location = 'login.html';
  }
});

//search button working and done
$('.search').on('click', function () {
  var input = document.querySelector("#movieName");
  var title = input.value;
  var url = info + title;
  var uid = fb.getAuth().uid;
  var token = fb.getAuth().token;
  var postUrl = FIREBASE_AUTH + "/users/" + uid + "/flicks.json?auth=" + token;
  $.get(url, function (data) {
    console.log(data);
    if (data.Response === "True") {
      $.post(postUrl, JSON.stringify(data), function (res) {
        console.log("Post Request Passed");
      });
      addMovieDetail(data);
    } else {
      alert("Sorry! Film not found! Check title and try again!");
    }
  }, 'jsonp');
});

//loads data per user and keeps its persisting
$(document).ready(function () {
  if (!/login\.html/.test(window.location.pathname) && fb.getAuth() !== null) {
    var uid = fb.getAuth().uid;
    var token = fb.getAuth().token;
    var MovieListUrl = FIREBASE_AUTH + "/users/" + uid + "/flicks.json?auth=" + token;
    $.get(MovieListUrl, function (movies) {
      Object.keys(movies).forEach(function (id) {
        addMovieDetail(movies[id], id);
      });
    });
  }
});

function addMovieDetail(data, id) {
  var $table = $(".table");
  $table.append("<tr></tr>");
  var $target = $("tr:last");
  scoreArr = scoreArr + Math.round(data.imdbRating) + " ";
  $target.attr("data-id", id);
  $target.append("<td>" + data.Title + "</td>");
  $target.append("<td>" + data.imdbRating + "</td>");
  $target.append("<td>" + data.Released + "</td>");
  $target.append("<td><img width='200' height='250' src=" + data.Poster + "></img></td>");
  $target.append("<button class='delete'>Delete</button>");
};

///Deletes individual users data from firebase
var $button = $('.table');
$button.on("click", ".delete", function () {
  var uid = fb.getAuth().uid;
  var token = fb.getAuth().token;
  var $movieRow = $(this).closest('tr');
  var id = $movieRow.attr('data-id');
  var deleteUrl = FIREBASE_AUTH + '/' + 'users' + '/' + uid + '/' + 'flicks' + '/' + id + '.json';
  $.ajax({
    url: deleteUrl,
    type: 'DELETE',
    success: function success() {
      $movieRow.remove();
    }
  });
});

//everything below this point is for login.html

//login button
$('.loginPageForm form').on('submit', function (evt) {
  var email = $('.loginPageForm input[type="email"]').val();
  var password = $('.loginPageForm input[type="password"]').val();
  var onTempPassword = $('.onTempPassword');
  evt.preventDefault();
  fb.authWithPassword({
    email: email,
    password: password
  }, function (err, authData) {
    if (err) {
      alert(err.toString());
    } else if (authData && authData.password.isTemporaryPassword) {
      onTempPassword.removeClass('hidden');
      alert("Please change your password now.");
    } else {
      window.location = 'index.html';
    }
  });
});

// runs when called by registration button if  successful
function doLogin(email, password, cb) {
  fb.authWithPassword({
    email: email,
    password: password
  }, function (err, authData) {
    if (err) {
      alert(err.toString());
    } else {
      saveAuthData(authData);
      typeof cb === 'function' && cb(authData);
      window.location = 'index.html';
      alert("Registration Successful!");
    }
  });
}

//saves the authentication data to firebase
function saveAuthData(authData) {
  $.ajax({
    method: 'PUT',
    url: FIREBASE_AUTH + "/users/" + authData.uid + "/profile.json",
    data: JSON.stringify(authData)
  });
}

//register button
$('.loginPageForm .doRegister').click(function () {
  var email = $('.loginPageForm input[type="email"]').val();
  var password = $('.loginPageForm input[type="password"]').val();

  fb.createUser({
    email: email,
    password: password
  }, function (err, userData) {
    if (err) {
      alert(err.toString());
    } else {
      doLogin(email, password);
    }
  });
  event.preventDefault();
});

//forgot password button
$('.loginPageForm .doResetPassword').click(function () {
  var email = $('.loginPageForm input[type="email"]').val();

  fb.resetPassword({
    email: email
  }, function (err) {
    if (err) {
      alert(err.toString());
    } else {
      alert('Check your email!');
    }
  });
});

//reset password form
$('.onTempPassword form').submit(function () {
  var email = fb.getAuth().password.email;
  var oldPw = $('.onTempPassword input:nth-child(1)').val();
  var newPw = $('.onTempPassword input:nth-child(2)').val();

  fb.changePassword({
    email: email,
    oldPassword: oldPw,
    newPassword: newPw
  }, function (err) {
    if (err) {
      alert(err.toString());
    } else {
      fb.unauth();
    }
  });

  event.preventDefault();
});

//reset password button
$('.onTempPassword form').submit(function () {
  var email = fb.getAuth().password.email;
  var oldPw = $('.onTempPassword input:nth-child(1)').val();
  var newPw = $('.onTempPassword input:nth-child(2)').val();

  fb.changePassword({
    email: email,
    oldPassword: oldPw,
    newPassword: newPw
  }, function (err) {
    if (err) {
      alert(err.toString());
    } else {
      fb.unauth();
      window.location = 'index.html';
    }
  });

  event.preventDefault();
});

//logout button
$('.logout').on('click', function () {
  fb.unauth();
  window.location = 'index.html';
});
//# sourceMappingURL=data:application/json;base64,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Q0FBQyxHQUFHLEVBQUUsQ0FBQzs7QUFFMUQsSUFBRSxDQUFDLGNBQWMsQ0FBQztBQUNoQixTQUFLLEVBQUUsS0FBSztBQUNaLGVBQVcsRUFBRSxLQUFLO0FBQ2xCLGVBQVcsRUFBRSxLQUFLO0dBQ25CLEVBQUUsVUFBUyxHQUFHLEVBQUU7QUFDZixRQUFJLEdBQUcsRUFBRTtBQUNQLFdBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztLQUN2QixNQUFNO0FBQ0wsUUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBQ1osWUFBTSxDQUFDLFFBQVEsR0FBRyxZQUFZLENBQUE7S0FDL0I7R0FDRixDQUFDLENBQUM7O0FBRUgsT0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO0NBQ3hCLENBQUMsQ0FBQTs7O0FBR0YsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsWUFBVztBQUNsQyxJQUFFLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDWixRQUFNLENBQUMsUUFBUSxHQUFHLFlBQVksQ0FBQTtDQUMvQixDQUFDLENBQUMiLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBpbmZvID0gXCJodHRwOi8vd3d3Lm9tZGJhcGkuY29tLz90PVwiO1xudmFyIHRpdGxlID0gJCgnLm1vdmllJykudmFsKCk7XG52YXIgdXJsID0gaW5mbyArIHRpdGxlO1xudmFyIEZJUkVCQVNFX1VSTCA9IFwiaHR0cHM6Ly9mbGlja3BpY2tlci5maXJlYmFzZWlvLmNvbS9mbGlja3MuanNvblwiXG52YXIgRklSRUJBU0VfQVVUSCA9ICdodHRwczovL2ZsaWNrcGlja2VyLmZpcmViYXNlaW8uY29tJztcbnZhciBmYiA9IG5ldyBGaXJlYmFzZShGSVJFQkFTRV9BVVRIKTtcbnZhciBzY29yZUFyciA9IFtdO1xuXG5cbi8vdGFzdGUgdGVzdCBidXR0b24gd29ya3MuXG4kKCcudGFzdGVUZXN0Jykub24oJ2NsaWNrJywgZnVuY3Rpb24oKXtcbiAgdmFyIHNjb3JlVG90YWxBcnIgPSBzY29yZUFyci5zcGxpdChcIiBcIikubWFwKE51bWJlcik7XG4gIHZhciAkdHRSZXN1bHQ9JChcIi5yYXRpbmdcIik7XG4gIHZhciB0b3RhbCA9IHNjb3JlVG90YWxBcnIucmVkdWNlKGZ1bmN0aW9uKHByZXYsIGN1cnIpIHtcbiAgcmV0dXJuIHByZXYgKyBjdXJyO1xufSk7XG5pZiAodG90YWwgPj0gNDUpIHtcbiAgYWRkVGFzdGVUZXN0UmVzdWx0KHRvdGFsKTtcbiAgJHR0UmVzdWx0LmFwcGVuZCgnPGltZyBzcmM9XCJodHRwOi8vdXBsb2FkLndpa2ltZWRpYS5vcmcvd2lraXBlZGlhL2VuL3RodW1iLzIvMmQvQ2VydGlmaWVkX0ZyZXNoLnN2Zy8xNTBweC1DZXJ0aWZpZWRfRnJlc2guc3ZnLnBuZ1wiPC9pbWc+JylcbiAgICAvL2FsZXJ0KFwiSGV5LCB5b3Uga25vdyBnb29kIGZpbG0gd2hlbiB5b3Ugc2VlIGl0ISAgWW91IHNob3VsZCBwdXQgZG93biB5b3VyIGZyaWVuZHMgb3BpbmlvbnMgYWJvdXQgbW92aWVzIG5vdyBiZWNhdXNlIHlvdXIgb3BpbmlvbnMgYXJlIGJldHRlciBhbmQgaGF2ZSBiZWVuIHJlYWZmaXJtZWQgYnkgbWUuICBHb3QgaXQ/XCIpXG4gIH0gZWxzZSBpZiAodG90YWwgPj0gNDApIHtcbiAgICBhbGVydChcIkFscmlnaHQsIHlvdSBsaWtlIGdvb2QgbW92aWVzIGJ1dCBoYXZlIHNvbWUgZ3VpbHR5IHBsZWFzdXJlcy4gIEl0cyBvay4gIEkgbGlrZSBNZWFuIEdpcmxzIHRvby5cIilcbiAgICB9XG4gICAgZWxzZSBpZiAodG90YWwgPj0gMzUpIHtcbiAgICAgIGFsZXJ0KFwiU29tZXRpbWVzIEkgd29uZGVyIGlmIHdlIG1lYW4gdGhlIHNhbWUgdGhpbmcgYnkgJ2dvb2QnLi4uXCIpXG4gICAgICB9XG4gICAgICBlbHNlIGlmKHRvdGFsID49IDMwKSB7XG4gICAgICAgIGFsZXJ0KFwiU3RlcCB5b3VyIGdhbWUgdXAuICBNaWdodCBJIHJlY29tbWVuZCBzdGFydGluZyB3aXRoICdHb29kZmVsbGFzIG9yIFRoZSBEZXBhcnRlZD8nXCIpXG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZih0b3RhbCA8IDMwKXtcbiAgICAgICAgICBhbGVydChcIllvdSBwcm9iYWJseSB0YWxrIGFuZCB0ZXh0IGluIHRoZWF0ZXJzIGFuZCBkZWZpbml0ZWx5IGRvbnQgZGVzZXJ2ZSBhIE5ldGZsaXggYWNjb3VudC5cIilcbiAgICAgICAgICB9O1xufSk7XG5cbi8vYXBwZW5kaW5nIHRhc3RlIHRlc3QgcmVzdWx0IHRvIHBhZ2VcbmZ1bmN0aW9uIGFkZFRhc3RlVGVzdFJlc3VsdCh0b3RhbCl7XG4gICAgdmFyICRyZW1vdmVCdG4gPSAkKCcucmVtb3ZlJylcbiAgICB2YXIgJHR0UmVzdWx0PSQoXCIucmF0aW5nXCIpO1xuICAgICRyZW1vdmVCdG4ucmVtb3ZlQ2xhc3MoJ2hpZGRlbicpO1xuICAgICR0dFJlc3VsdC5hcHBlbmQoXCJUYXN0ZSBUZXN0IFNjb3JlOiBcIiwgdG90YWwpO1xuICAgICR0dFJlc3VsdC5yZW1vdmVDbGFzcygnaGlkZGVuJyk7XG5cbiAgfVxuXG4vLyAvL3RyeWluZyB0byBnZXQgdGhlIHRhc3RlIHRlc3QgcmVzdWx0IHRvIGhpZGUgb24gYnV0dG9uIGNsaWNrXG4kKCcucmVtb3ZlJykub24oJ2NsaWNrJywgZnVuY3Rpb24oKXtcbiAgICB2YXIgJHR0UmVzdWx0ID0gJChcIi5yYXRpbmdcIik7XG4gICAgdmFyICRyZW1vdmVCdG4gPSAkKCcucmVtb3ZlJylcbiAgICAkcmVtb3ZlQnRuLmFkZENsYXNzKCdoaWRkZW4nKTtcbiAgICAkdHRSZXN1bHQuYWRkQ2xhc3MoXCJoaWRkZW5cIik7XG4gICAgJHR0UmVzdWx0LmVtcHR5KCcucmF0aW5nJyk7XG4gIH0pXG5cbi8vb24gcGFnZSBsb2FkIGl0IGNoZWNrcyBpZiB5b3UgYXJlIGxvZ2dlZCBpbi4gIElmIHlvdSBhcmVudCwgaXQgc2VuZHMgeW91IHRvIGxvZ2luIHBhZ2UuXG4kKCBkb2N1bWVudCApLnJlYWR5KGZ1bmN0aW9uKCkge1xuaWYgKC9sb2dpblxcLmh0bWwvLnRlc3Qod2luZG93LmxvY2F0aW9uLnBhdGhuYW1lKSAmJiAhZmIuZ2V0QXV0aCgpKSB7XG4gd2luZG93LmxvY2F0aW9uID0nbG9naW4uaHRtbCc7XG4gICAgfVxuICB9KTtcblxuLy9zZWFyY2ggYnV0dG9uIHdvcmtpbmcgYW5kIGRvbmVcbiQoJy5zZWFyY2gnKS5vbignY2xpY2snLCBmdW5jdGlvbigpIHtcbiAgdmFyIGlucHV0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIiNtb3ZpZU5hbWVcIik7XG4gIHZhciB0aXRsZSA9IGlucHV0LnZhbHVlO1xuICB2YXIgdXJsID0gaW5mbyArIHRpdGxlO1xuICB2YXIgdWlkID0gZmIuZ2V0QXV0aCgpLnVpZDtcbiAgdmFyIHRva2VuID0gZmIuZ2V0QXV0aCgpLnRva2VuO1xuICB2YXIgcG9zdFVybCA9IGAke0ZJUkVCQVNFX0FVVEh9L3VzZXJzLyR7dWlkfS9mbGlja3MuanNvbj9hdXRoPSR7dG9rZW59YDtcbiAgJC5nZXQodXJsLCBmdW5jdGlvbiAoZGF0YSkge1xuICAgIGNvbnNvbGUubG9nKGRhdGEpO1xuICAgIGlmKGRhdGEuUmVzcG9uc2UgPT09IFwiVHJ1ZVwiKXtcbiAgICAkLnBvc3QocG9zdFVybCwgSlNPTi5zdHJpbmdpZnkoZGF0YSksIGZ1bmN0aW9uIChyZXMpIHtcbiAgICBjb25zb2xlLmxvZyhcIlBvc3QgUmVxdWVzdCBQYXNzZWRcIilcbiAgfSk7XG4gICAgYWRkTW92aWVEZXRhaWwoZGF0YSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGFsZXJ0KFwiU29ycnkhIEZpbG0gbm90IGZvdW5kISBDaGVjayB0aXRsZSBhbmQgdHJ5IGFnYWluIVwiKVxuICAgIH1cbiAgfSwgJ2pzb25wJyk7XG59KTtcblxuLy9sb2FkcyBkYXRhIHBlciB1c2VyIGFuZCBrZWVwcyBpdHMgcGVyc2lzdGluZ1xuJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKXtcbiAgaWYgKCEoL2xvZ2luXFwuaHRtbC8udGVzdCh3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUpKSAmJiBmYi5nZXRBdXRoKCkgIT09IG51bGwpe1xuICAgIHZhciB1aWQgPSBmYi5nZXRBdXRoKCkudWlkO1xuICAgIHZhciB0b2tlbiA9IGZiLmdldEF1dGgoKS50b2tlbjtcbiAgICB2YXIgTW92aWVMaXN0VXJsID0gYCR7RklSRUJBU0VfQVVUSH0vdXNlcnMvJHt1aWR9L2ZsaWNrcy5qc29uP2F1dGg9JHt0b2tlbn1gO1xuICAgICQuZ2V0KE1vdmllTGlzdFVybCwgZnVuY3Rpb24gKG1vdmllcykge1xuICAgICAgT2JqZWN0LmtleXMobW92aWVzKS5mb3JFYWNoKGZ1bmN0aW9uIChpZCkge1xuICAgICAgYWRkTW92aWVEZXRhaWwobW92aWVzW2lkXSwgaWQpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbn0pO1xuXG5cbmZ1bmN0aW9uIGFkZE1vdmllRGV0YWlsKGRhdGEsIGlkKXtcbiAgdmFyICR0YWJsZT0kKFwiLnRhYmxlXCIpO1xuICAgICR0YWJsZS5hcHBlbmQoXCI8dHI+PC90cj5cIik7XG4gICAgdmFyICR0YXJnZXQ9JChcInRyOmxhc3RcIik7XG4gICAgc2NvcmVBcnIgPSBzY29yZUFyciArIE1hdGgucm91bmQoZGF0YS5pbWRiUmF0aW5nKSArIFwiIFwiO1xuICAgICAgJHRhcmdldC5hdHRyKFwiZGF0YS1pZFwiLCBpZCk7XG4gICAgICAkdGFyZ2V0LmFwcGVuZChcIjx0ZD5cIiArIGRhdGEuVGl0bGUgKyBcIjwvdGQ+XCIpO1xuICAgICAgJHRhcmdldC5hcHBlbmQoXCI8dGQ+XCIgKyBkYXRhLmltZGJSYXRpbmcgKyBcIjwvdGQ+XCIpO1xuICAgICAgJHRhcmdldC5hcHBlbmQoXCI8dGQ+XCIgKyBkYXRhLlJlbGVhc2VkICsgXCI8L3RkPlwiKTtcbiAgICAgICR0YXJnZXQuYXBwZW5kKFwiPHRkPjxpbWcgd2lkdGg9JzIwMCcgaGVpZ2h0PScyNTAnIHNyYz1cIiArIGRhdGEuUG9zdGVyICsgXCI+PC9pbWc+PC90ZD5cIik7XG4gICAgICAkdGFyZ2V0LmFwcGVuZChcIjxidXR0b24gY2xhc3M9J2RlbGV0ZSc+RGVsZXRlPC9idXR0b24+XCIpO1xufTtcblxuLy8vRGVsZXRlcyBpbmRpdmlkdWFsIHVzZXJzIGRhdGEgZnJvbSBmaXJlYmFzZVxudmFyICRidXR0b24gPSAkKCcudGFibGUnKTtcbiRidXR0b24ub24oXCJjbGlja1wiLCBcIi5kZWxldGVcIiwgZnVuY3Rpb24oKSB7XG4gIHZhciB1aWQgPSBmYi5nZXRBdXRoKCkudWlkO1xuICB2YXIgdG9rZW4gPSBmYi5nZXRBdXRoKCkudG9rZW5cbiAgdmFyICRtb3ZpZVJvdyA9ICQodGhpcykuY2xvc2VzdCgndHInKTtcbiAgdmFyIGlkID0gJG1vdmllUm93LmF0dHIoJ2RhdGEtaWQnKTtcbiAgdmFyIGRlbGV0ZVVybCA9IEZJUkVCQVNFX0FVVEggKyAnLycgKyAndXNlcnMnICsgJy8nICsgdWlkICsgJy8nICsgJ2ZsaWNrcycgKyAnLycgKyBpZCArICcuanNvbic7XG4gICAgJC5hamF4KHtcbiAgICB1cmw6IGRlbGV0ZVVybCxcbiAgICB0eXBlOiAnREVMRVRFJyxcbiAgICBzdWNjZXNzOiBmdW5jdGlvbigpIHtcbiAgICAgICRtb3ZpZVJvdy5yZW1vdmUoKTtcbiAgICB9XG4gIH0pXG59KTtcblxuLy9ldmVyeXRoaW5nIGJlbG93IHRoaXMgcG9pbnQgaXMgZm9yIGxvZ2luLmh0bWxcblxuLy9sb2dpbiBidXR0b25cbiQoJy5sb2dpblBhZ2VGb3JtIGZvcm0nKS5vbignc3VibWl0JywgZnVuY3Rpb24gKGV2dCkge1xuICB2YXIgZW1haWwgPSAkKCcubG9naW5QYWdlRm9ybSBpbnB1dFt0eXBlPVwiZW1haWxcIl0nKS52YWwoKTtcbiAgdmFyIHBhc3N3b3JkID0gJCgnLmxvZ2luUGFnZUZvcm0gaW5wdXRbdHlwZT1cInBhc3N3b3JkXCJdJykudmFsKCk7XG4gIHZhciBvblRlbXBQYXNzd29yZCA9ICQoJy5vblRlbXBQYXNzd29yZCcpO1xuICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgZmIuYXV0aFdpdGhQYXNzd29yZCh7XG4gICAgZW1haWw6IGVtYWlsLFxuICAgIHBhc3N3b3JkOiBwYXNzd29yZFxuICB9LCBmdW5jdGlvbiAoZXJyLCBhdXRoRGF0YSkge1xuICAgIGlmIChlcnIpIHtcbiAgICAgIGFsZXJ0KGVyci50b1N0cmluZygpKTtcbiAgICB9IGVsc2UgaWYoYXV0aERhdGEgJiYgYXV0aERhdGEucGFzc3dvcmQuaXNUZW1wb3JhcnlQYXNzd29yZCkge1xuICAgICAgb25UZW1wUGFzc3dvcmQucmVtb3ZlQ2xhc3MoJ2hpZGRlbicpO1xuICAgICAgYWxlcnQoXCJQbGVhc2UgY2hhbmdlIHlvdXIgcGFzc3dvcmQgbm93LlwiKVxuICAgIH0gZWxzZSB7XG4gICAgICB3aW5kb3cubG9jYXRpb24gPSAnaW5kZXguaHRtbCdcbiAgICB9XG4gIH0pO1xufSk7XG5cbi8vIHJ1bnMgd2hlbiBjYWxsZWQgYnkgcmVnaXN0cmF0aW9uIGJ1dHRvbiBpZiAgc3VjY2Vzc2Z1bFxuZnVuY3Rpb24gZG9Mb2dpbiAoZW1haWwsIHBhc3N3b3JkLCBjYikge1xuICBmYi5hdXRoV2l0aFBhc3N3b3JkKHtcbiAgICBlbWFpbDogZW1haWwsXG4gICAgcGFzc3dvcmQ6IHBhc3N3b3JkXG4gIH0sIGZ1bmN0aW9uIChlcnIsIGF1dGhEYXRhKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgYWxlcnQoZXJyLnRvU3RyaW5nKCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzYXZlQXV0aERhdGEoYXV0aERhdGEpO1xuICAgICAgdHlwZW9mIGNiID09PSAnZnVuY3Rpb24nICYmIGNiKGF1dGhEYXRhKTtcbiAgICAgIHdpbmRvdy5sb2NhdGlvbiA9ICdpbmRleC5odG1sJ1xuICAgICAgYWxlcnQoXCJSZWdpc3RyYXRpb24gU3VjY2Vzc2Z1bCFcIilcbiAgICB9XG4gIH0pO1xufVxuXG4vL3NhdmVzIHRoZSBhdXRoZW50aWNhdGlvbiBkYXRhIHRvIGZpcmViYXNlXG5mdW5jdGlvbiBzYXZlQXV0aERhdGEgKGF1dGhEYXRhKSB7XG4gICQuYWpheCh7XG4gICAgbWV0aG9kOiAnUFVUJyxcbiAgICB1cmw6IGAke0ZJUkVCQVNFX0FVVEh9L3VzZXJzLyR7YXV0aERhdGEudWlkfS9wcm9maWxlLmpzb25gLFxuICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KGF1dGhEYXRhKVxuICB9KTtcbn1cblxuXG4vL3JlZ2lzdGVyIGJ1dHRvblxuJCgnLmxvZ2luUGFnZUZvcm0gLmRvUmVnaXN0ZXInKS5jbGljayhmdW5jdGlvbiAoKSB7XG4gIHZhciBlbWFpbCA9ICQoJy5sb2dpblBhZ2VGb3JtIGlucHV0W3R5cGU9XCJlbWFpbFwiXScpLnZhbCgpO1xuICB2YXIgcGFzc3dvcmQgPSAkKCcubG9naW5QYWdlRm9ybSBpbnB1dFt0eXBlPVwicGFzc3dvcmRcIl0nKS52YWwoKTtcblxuICBmYi5jcmVhdGVVc2VyKHtcbiAgICBlbWFpbDogZW1haWwsXG4gICAgcGFzc3dvcmQ6IHBhc3N3b3JkXG4gIH0sIGZ1bmN0aW9uIChlcnIsIHVzZXJEYXRhKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgYWxlcnQoZXJyLnRvU3RyaW5nKCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBkb0xvZ2luKGVtYWlsLCBwYXNzd29yZCk7XG4gICAgfVxuICB9KTtcbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbn0pO1xuXG4vL2ZvcmdvdCBwYXNzd29yZCBidXR0b25cbiQoJy5sb2dpblBhZ2VGb3JtIC5kb1Jlc2V0UGFzc3dvcmQnKS5jbGljayhmdW5jdGlvbiAoKSB7XG4gIHZhciBlbWFpbCA9ICQoJy5sb2dpblBhZ2VGb3JtIGlucHV0W3R5cGU9XCJlbWFpbFwiXScpLnZhbCgpO1xuXG4gIGZiLnJlc2V0UGFzc3dvcmQoe1xuICAgIGVtYWlsOiBlbWFpbFxuICB9LCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgYWxlcnQoZXJyLnRvU3RyaW5nKCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhbGVydCgnQ2hlY2sgeW91ciBlbWFpbCEnKTtcbiAgICB9XG4gIH0pO1xufSk7XG5cbi8vcmVzZXQgcGFzc3dvcmQgZm9ybVxuJCgnLm9uVGVtcFBhc3N3b3JkIGZvcm0nKS5zdWJtaXQoZnVuY3Rpb24gKCkge1xuICB2YXIgZW1haWwgPSBmYi5nZXRBdXRoKCkucGFzc3dvcmQuZW1haWw7XG4gIHZhciBvbGRQdyA9ICQoJy5vblRlbXBQYXNzd29yZCBpbnB1dDpudGgtY2hpbGQoMSknKS52YWwoKTtcbiAgdmFyIG5ld1B3ID0gJCgnLm9uVGVtcFBhc3N3b3JkIGlucHV0Om50aC1jaGlsZCgyKScpLnZhbCgpO1xuXG4gIGZiLmNoYW5nZVBhc3N3b3JkKHtcbiAgICBlbWFpbDogZW1haWwsXG4gICAgb2xkUGFzc3dvcmQ6IG9sZFB3LFxuICAgIG5ld1Bhc3N3b3JkOiBuZXdQd1xuICB9LCBmdW5jdGlvbihlcnIpIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBhbGVydChlcnIudG9TdHJpbmcoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZiLnVuYXV0aCgpO1xuICAgIH1cbiAgfSk7XG5cbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbn0pXG5cbi8vcmVzZXQgcGFzc3dvcmQgYnV0dG9uXG4kKCcub25UZW1wUGFzc3dvcmQgZm9ybScpLnN1Ym1pdChmdW5jdGlvbiAoKSB7XG4gIHZhciBlbWFpbCA9IGZiLmdldEF1dGgoKS5wYXNzd29yZC5lbWFpbDtcbiAgdmFyIG9sZFB3ID0gJCgnLm9uVGVtcFBhc3N3b3JkIGlucHV0Om50aC1jaGlsZCgxKScpLnZhbCgpO1xuICB2YXIgbmV3UHcgPSAkKCcub25UZW1wUGFzc3dvcmQgaW5wdXQ6bnRoLWNoaWxkKDIpJykudmFsKCk7XG5cbiAgZmIuY2hhbmdlUGFzc3dvcmQoe1xuICAgIGVtYWlsOiBlbWFpbCxcbiAgICBvbGRQYXNzd29yZDogb2xkUHcsXG4gICAgbmV3UGFzc3dvcmQ6IG5ld1B3XG4gIH0sIGZ1bmN0aW9uKGVycikge1xuICAgIGlmIChlcnIpIHtcbiAgICAgIGFsZXJ0KGVyci50b1N0cmluZygpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZmIudW5hdXRoKCk7XG4gICAgICB3aW5kb3cubG9jYXRpb24gPSAnaW5kZXguaHRtbCdcbiAgICB9XG4gIH0pO1xuXG4gIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG59KVxuXG4vL2xvZ291dCBidXR0b25cbiQoJy5sb2dvdXQnKS5vbignY2xpY2snLCBmdW5jdGlvbigpIHtcbiAgZmIudW5hdXRoKCk7XG4gIHdpbmRvdy5sb2NhdGlvbiA9ICdpbmRleC5odG1sJ1xufSk7XG4iXX0=